name: Build & Deploy IRIS API

on:
  push:
    branches:
      - week6

env:
  GAR_LOCATION: "us-central1"           # GCP region for Artifact Registry
  GKE_CLUSTER: "iris-cluster"           # GKE cluster name
  GKE_REGION: "us-central1"             # GKE region
  REPOSITORY: "iris-app-repo"           # Artifact Registry repo name
  IMAGE_NAME: "iris-api"                # Docker image name
  DEPLOYMENT_NAME: "iris-api-deployment" # K8s deployment name
  SERVICE_NAME: "iris-api-service"      # K8s service name

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      # 1️⃣ Checkout repo
      - uses: actions/checkout@v4

      # 2️⃣ Authenticate to Google Cloud
      - name: Authenticate to GCP
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      # 3️⃣ Configure Docker for Artifact Registry
      - run: gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev --quiet

      # 4️⃣ Build and Push Docker Image
      - name: Build & Push Docker Image
        run: |
          IMAGE_TAG="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          docker build -t "$IMAGE_TAG" .
          docker push "$IMAGE_TAG"
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      # 5️⃣ Get GKE Credentials
      - name: Get GKE Credentials
        run: gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} --region ${{ env.GKE_REGION }}

      # 6️⃣ Deploy to GKE
      - name: Deploy to GKE
        run: |
          kubectl set image deployment/${{ env.DEPLOYMENT_NAME }} iris-api-container=$IMAGE_TAG --record
          kubectl rollout status deployment/${{ env.DEPLOYMENT_NAME }} --timeout=300s
          kubectl get pods -l app=${{ env.IMAGE_NAME }}

      # 7️⃣ Wait for Service IP & Test API
      - name: Wait & Test API
        run: |
          echo "Waiting for external IP..."
          for i in {1..30}; do
            SERVICE_IP=$(kubectl get svc ${{ env.SERVICE_NAME }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null)
            [ -n "$SERVICE_IP" ] && break || sleep 10
          done
          [ -z "$SERVICE_IP" ] && echo "No IP yet" && exit 0
          echo "Service available at: $SERVICE_IP"
          sleep 30
          curl -X POST "http://$SERVICE_IP/predict" \
            -H "Content-Type: application/json" \
            -d '{"sepal_length":5.1,"sepal_width":3.5,"petal_length":1.4,"petal_width":0.2}'
